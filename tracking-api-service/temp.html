<script>
  // Khởi tạo Cube.js client
  const cubejsApi = cubejs(
    'secret123', // API Token
    { apiUrl: 'http://localhost:4000/cubejs-api/v1' }
  );

  // Khởi tạo các biểu đồ Chart.js 
  const checkoutChart = new Chart(document.getElementById('checkoutChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Số lần checkout', data: [], backgroundColor: 'rgba(52, 152, 219, 0.4)', borderColor: 'rgba(41, 128, 185, 1)', borderWidth: 2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Số lần' } },
        x: { title: { display: true, text: 'Sản phẩm' } }
      },
      plugins: { legend: { display: false } }
    }
  });

  const userRevenueChart = new Chart(document.getElementById('userRevenueChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Doanh thu', data: [], backgroundColor: 'rgba(255, 159, 64, 0.4)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 2 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'VNĐ' } },
        x: { title: { display: true, text: 'User ID' } }
      },
      plugins: { legend: { display: false } }
    }
  });

  const dailyRevenueChart = new Chart(document.getElementById('dailyRevenueChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Doanh thu theo ngày', data: [], backgroundColor: 'rgba(46, 204, 113, 0.2)', borderColor: 'rgba(39, 174, 96, 1)', borderWidth: 2, fill: true, tension: 0.3 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Ngày' } },
        y: { beginAtZero: true, title: { display: true, text: 'VNĐ' } }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Hàm làm mới dashboard
  async function refreshDashboard() {
    console.log("Refreshing dashboard...");

    // Tổng doanh thu
    const totalRevenueResult = await cubejsApi.load({
      measures: ["CheckoutItems.totalRevenue"]
    });
    const total = totalRevenueResult.rawData()[0]?.["CheckoutItems.totalRevenue"] || 0;
    console.log("Total revenue data:", total);
    document.getElementById('revenue-box').textContent = 'Tổng doanh thu: ₫' + total.toLocaleString('vi-VN');

    // Checkout theo sản phẩm
    const checkoutResult = await cubejsApi.load({
      measures: ["CheckoutItems.totalQuantity"],
      dimensions: ["CheckoutItems.product_name"],
      order: { "CheckoutItems.totalQuantity": "desc" },
      limit: 10
    });
    console.log("Checkout chart data:", checkoutResult.rawData());
    cubejsChartjs.renderChart(checkoutChart, checkoutResult, {
      x: "CheckoutItems.product_name",
      y: ["CheckoutItems.totalQuantity"],
      type: 'bar'
    });

    // Doanh thu theo khách hàng
    const userRevenueResult = await cubejsApi.load({
      measures: ["CheckoutItems.totalRevenue"],
      dimensions: ["CheckoutItems.user_id"],
      order: { "CheckoutItems.totalRevenue": "desc" },
      limit: 10
    });
    console.log("User revenue chart data:", userRevenueResult.rawData());
    cubejsChartjs.renderChart(userRevenueChart, userRevenueResult, {
      x: "CheckoutItems.user_id",
      y: ["CheckoutItems.totalRevenue"],
      type: 'bar'
    });

    // Doanh thu theo ngày
    const dailyRevenueResult = await cubejsApi.load({
      measures: ["CheckoutItems.totalRevenue"],
      dimensions: ["CheckoutItems.timestamp"],
      timeDimensions: [{
        dimension: "CheckoutItems.timestamp",
        granularity: "day"
      }],
      order: { "CheckoutItems.timestamp": "asc" }
    });
    console.log("Daily revenue chart data:", dailyRevenueResult.rawData());
    cubejsChartjs.renderChart(dailyRevenueChart, dailyRevenueResult, {
      x: "CheckoutItems.timestamp",
      y: ["CheckoutItems.totalRevenue"],
      type: 'line'
    });
  }

  // Khởi tạo SocketIO
  const socket = io('/');

  // Làm mới dashboard khi tải trang
  window.onload = refreshDashboard;

  // Làm mới dashboard khi nhận tín hiệu từ SocketIO
  socket.on('dashboard_refresh', () => {
    console.log("Received dashboard_refresh signal");
    refreshDashboard();
  });
</script>